<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil ‚Äî DatArchi</title>
    <link rel="stylesheet" href="../../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module" src="../../js/injectHeaderFooter.js"></script>
    <style>
        .auth-login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            padding: 40px 20px;
            background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
            width: 100%;
            position: relative;
            z-index: 10;
        }

        .auth-login-wrapper {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 50px 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            max-width: 500px;
            width: 100%;
        }

        .auth-login-wrapper h2 {
            font-size: 28px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #f97316, #ea580c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
        }

        .auth-login-wrapper .form-subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .profile-auth-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 0;
        }

        .profile-auth-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .profile-auth-tab.active {
            color: #f97316;
            border-bottom-color: #f97316;
        }

        .profile-auth-form {
            display: none;
        }

        .profile-auth-form.active {
            display: block;
        }

        .profile-container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 20px;
        }

        body {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            min-height: 100vh;
            padding-bottom: 40px;
        }

        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 50px 40px;
            text-align: center;
            color: white;
            margin-bottom: 40px;
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
            border-bottom: none;
        }

        .profile-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) translateX(0px); }
            50% { transform: translateY(-20px) translateX(20px); }
        }

        .profile-header-content {
            position: relative;
            z-index: 1;
        }

        .profile-avatar {
            width: 140px;
            height: 140px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            font-size: 56px;
            color: #f97316;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border: 4px solid white;
            transition: all 0.3s ease;
        }

        .profile-avatar:hover {
            transform: scale(1.05);
        }

        .profile-header h1 {
            font-size: 36px;
            color: white;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .profile-header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            margin-bottom: 30px;
        }

        .avatar-upload-btn {
            padding: 10px 24px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
        }

        .avatar-upload-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .profile-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 0;
            border-bottom: none;
            flex-wrap: wrap;
            background: white;
            border-radius: 16px 16px 0 0;
            padding: 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .profile-tab {
            padding: 16px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            color: #666;
            border-bottom: 4px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
            white-space: nowrap;
            position: relative;
        }

        .profile-tab:hover {
            color: #f97316;
            background: rgba(249, 115, 22, 0.05);
        }

        .profile-tab.active {
            color: white;
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            border-bottom-color: transparent;
        }

        .profile-tab i {
            margin-right: 8px;
        }

        .profile-sections-wrapper {
            background: white;
            border-radius: 0 0 16px 16px;
            padding: 40px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .profile-section {
            display: none;
        }

        .profile-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #f97316;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e8eef7;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
            background: #f8faff;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #f97316;
            background: white;
            box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.1);
            transform: translateY(-2px);
        }

        .form-group input:disabled {
            background: #f5f5f5;
            color: #6b5b52;
            cursor: not-allowed;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .profile-header {
                padding: 40px 20px;
            }
            .profile-sections-wrapper {
                padding: 20px;
            }
            .profile-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .profile-tab {
                padding: 14px 16px;
                font-size: 13px;
                white-space: nowrap;
            }
            .profile-info-display {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            .profile-avatar {
                width: 120px;
                height: 120px;
                font-size: 48px;
            }
            .profile-header h1 {
                font-size: 28px;
            }
        }

        @media (max-width: 480px) {
            .profile-container {
                padding: 0 12px;
            }
            .profile-header {
                padding: 30px 16px;
                margin-bottom: 24px;
            }
            .profile-sections-wrapper {
                padding: 16px;
                border-radius: 12px 12px 0 0;
            }
            .form-group {
                margin-bottom: 18px;
            }
            .profile-avatar {
                width: 100px;
                height: 100px;
                font-size: 40px;
                margin-bottom: 20px;
            }
            .btn {
                padding: 11px 20px;
                font-size: 13px;
            }
            .profile-actions {
                flex-direction: column;
                gap: 10px;
            }
            .btn-block {
                width: 100%;
            }
        }

        .profile-actions {
            display: flex;
            gap: 12px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e8eef7;
        }

        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(249, 115, 22, 0.4);
        }

        .btn-secondary {
            background: #fff5f0;
            color: #f97316;
            border: 2px solid #ffe8d6;
        }

        .btn-secondary:hover {
            background: #ffe8d6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.15);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(249, 115, 22, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 14px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-danger {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .alert-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .info-box {
            background: linear-gradient(135deg, #fff5f0 0%, #ffe8d6 100%);
            border-left: 4px solid #f97316;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #0c5460;
        }

        .password-requirement {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            padding: 10px 14px;
            background: #fff5f0;
            border-radius: 8px;
            border-left: 3px solid #f97316;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(249, 115, 22, 0.2);
            border-top-color: #f97316;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .profile-info-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 30px;
        }

        .info-item {
            padding: 20px;
            background: linear-gradient(135deg, #fff5f0 0%, #ffe8d6 100%);
            border-radius: 12px;
            border: 2px solid #ffe8d6;
            transition: all 0.3s ease;
        }

        .info-item:hover {
            border-color: #f97316;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.15);
            transform: translateY(-2px);
        }

        .info-label {
            font-size: 12px;
            color: #f97316;
            text-transform: uppercase;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 18px;
            color: #333;
            font-weight: 700;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        #headerLogoutBtn {
            padding: 10px 24px !important;
            font-size: 13px !important;
        }

</head>
<body>
    <div id="header-container"></div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" style="display: flex; align-items: center; justify-content: center; min-height: 70vh; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);">
        <div style="text-align: center; color: white;">
            <div style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
            <p style="font-size: 18px; font-weight: 600; margin: 0;">Profil wird geladen...</p>
            <p style="font-size: 12px; color: rgba(255,255,255,0.7); margin: 10px 0 0 0;">Bitte warten...</p>
        </div>
    </div>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <!-- Auth Section (shown when not logged in) -->
    <div id="auth-section" class="auth-login-container" style="display: none;">
        <div class="auth-login-wrapper">
            <div class="profile-auth-tabs">
                <button class="profile-auth-tab active" data-form="login">
                    <i class="fas fa-sign-in-alt"></i> Anmelden
                </button>
                <button class="profile-auth-tab" data-form="register">
                    <i class="fas fa-user-plus"></i> Registrieren
                </button>
            </div>

            <!-- Login Form -->
            <form id="profileLoginForm" class="profile-auth-form active">
                <h2>Willkommen zur√ºck</h2>
                <p class="form-subtitle">Melden Sie sich an, um auf Ihr Profil zuzugreifen</p>
                
                <div class="form-group">
                    <label for="profileLoginEmail">E-Mail</label>
                    <input type="email" id="profileLoginEmail" required placeholder="your@email.com">
                </div>

                <div class="form-group">
                    <label for="profileLoginPassword">Passwort</label>
                    <div style="position: relative;">
                        <input type="password" id="profileLoginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <button type="button" class="password-toggle-btn" data-target="profileLoginPassword" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #666;">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div id="loginError" hidden style="padding: 12px 15px; background: #f8d7da; color: #721c24; border-radius: 8px; margin-bottom: 15px; font-size: 14px;">
                    <span></span>
                </div>

                <button type="submit" class="submit-btn" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #f97316, #fb923c); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                    <i class="fas fa-sign-in-alt"></i> Anmelden
                </button>
            </form>

            <!-- Register Form -->
            <form id="profileRegisterForm" class="profile-auth-form">
                <h2>Konto erstellen</h2>
                <p class="form-subtitle">Registrieren Sie sich, um mit DatArchi zu beginnen</p>

                <div class="form-group">
                    <label for="profileRegisterEmail">E-Mail</label>
                    <input type="email" id="profileRegisterEmail" required placeholder="your@email.com">
                </div>

                <div class="form-group">
                    <label for="profileRegisterPassword">Passwort</label>
                    <div style="position: relative;">
                        <input type="password" id="profileRegisterPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <button type="button" class="password-toggle-btn" data-target="profileRegisterPassword" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #666;">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div id="registerError" hidden style="padding: 12px 15px; background: #f8d7da; color: #721c24; border-radius: 8px; margin-bottom: 15px; font-size: 14px;">
                    <span></span>
                </div>

                <div id="registerSuccess" hidden style="padding: 12px 15px; background: #d4edda; color: #155724; border-radius: 8px; margin-bottom: 15px; font-size: 14px;">
                    <span></span>
                </div>

                <button type="submit" class="submit-btn" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #f97316, #fb923c); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                    <i class="fas fa-user-plus"></i> Konto erstellen
                </button>
            </form>
        </div>
    </div>

    <div class="profile-container" id="profile-content" style="display: none;">
        <div class="profile-header">
            <div class="profile-avatar" id="profileAvatarDisplay">
                <i class="fas fa-user"></i>
            </div>
            <div style="position: relative; width: fit-content; margin: -15px auto 20px;">
                <label for="avatarUpload" class="btn btn-primary btn-sm" style="cursor: pointer; font-size: 12px;">
                    <i class="fas fa-camera"></i> Profilbild √§ndern
                </label>
                <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
            </div>
            <h1 id="profileName">Benutzer</h1>
            <p id="profileEmail">example@email.com</p>
            <button id="headerLogoutBtn" class="btn btn-secondary" style="margin-top: 20px;">
                <i class="fas fa-sign-out-alt"></i> Abmelden
            </button>
        </div>

        <!-- Tabs -->
        <div class="profile-tabs">
            <button class="profile-tab active" data-section="personal">
                <i class="fas fa-user-circle"></i> Pers√∂nliche Daten
            </button>
            <button class="profile-tab" data-section="password">
                <i class="fas fa-lock"></i> Passwort √§ndern
            </button>
            <button class="profile-tab" data-section="settings">
                <i class="fas fa-cog"></i> Einstellungen
            </button>
        </div>

        <div class="profile-sections-wrapper">
        <!-- Personal Information Section -->
        <div id="personal" class="profile-section active">
            <div class="info-box">
                <i class="fas fa-info-circle"></i> 
                Aktualisieren Sie Ihre pers√∂nlichen Informationen hier.
            </div>

            <div id="personalSuccess" class="alert alert-success" hidden>
                <i class="fas fa-check-circle"></i>
                <span></span>
            </div>
            <div id="personalError" class="alert alert-danger" hidden>
                <i class="fas fa-exclamation-circle"></i>
                <span></span>
            </div>

            <form id="personalForm">
                <div class="form-group">
                    <label for="fullName">Vollst√§ndiger Name</label>
                    <input type="text" id="fullName" required>
                </div>

                <div class="form-group">
                    <label for="username">Benutzername</label>
                    <input type="text" id="username" required placeholder="z.B. archeologe_2024">
                    <div class="password-requirement">
                        Eindeutiger Benutzername - kann von anderen Nutzern zum Einladen verwendet werden
                    </div>
                </div>

                <div class="form-group">
                    <label for="email">E-Mail-Adresse</label>
                    <input type="email" id="email" disabled>
                    <div class="password-requirement">
                        <i class="fas fa-lock"></i> E-Mail kann auf der Seite "Passwort √§ndern" aktualisiert werden
                    </div>
                </div>

                <div class="form-group">
                    <label for="role">Benutzerrolle</label>
                    <input type="text" id="role" disabled>
                </div>

                <div class="form-group">
                    <label for="projects">Meine Projekte</label>
                    <div id="projects" style="padding: 12px; background: rgba(0,0,0,0.02); border-radius: 8px; border: 1px solid var(--border); min-height: 60px;">
                        <p class="text-muted" style="margin: 0; font-size: 12px;">Wird automatisch aktualisiert...</p>
                    </div>
                </div>

                <div class="profile-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Speichern
                    </button>
                    <button type="reset" class="btn btn-secondary">
                        <i class="fas fa-undo"></i> Zur√ºcksetzen
                    </button>
                </div>
            </form>
        </div>

        <!-- Password Section -->
        <div id="password" class="profile-section">
            <div class="info-box">
                <i class="fas fa-info-circle"></i> 
                √Ñndern Sie Ihr Passwort oder E-Mail-Adresse hier.
            </div>

            <div id="passwordSuccess" class="alert alert-success" hidden>
                <i class="fas fa-check-circle"></i>
                <span></span>
            </div>
            <div id="passwordError" class="alert alert-danger" hidden>
                <i class="fas fa-exclamation-circle"></i>
                <span></span>
            </div>

            <!-- Change Password Form -->
            <div style="margin-bottom: 40px; padding-bottom: 30px; border-bottom: 2px solid #e0e0e0;">
                <h3 style="font-size: 16px; margin-bottom: 20px; color: #333;">Passwort √§ndern</h3>
                <form id="changePasswordForm">
                    <div class="form-group">
                        <label for="currentPassword">Aktuelles Passwort</label>
                        <input type="password" id="currentPassword" required>
                    </div>

                    <div class="form-group">
                        <label for="newPassword">Neues Passwort</label>
                        <input type="password" id="newPassword" required minlength="6">
                        <div class="password-requirement">
                            Mindestens 6 Zeichen erforderlich
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">Passwort best√§tigen</label>
                        <input type="password" id="confirmPassword" required minlength="6">
                    </div>

                    <div class="profile-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-lock"></i> Passwort √§ndern
                        </button>
                        <button type="reset" class="btn btn-secondary">
                            <i class="fas fa-undo"></i> Zur√ºcksetzen
                        </button>
                    </div>
                </form>
            </div>

            <!-- Change Email Form -->
            <div>
                <h3 style="font-size: 16px; margin-bottom: 20px; color: #333;">E-Mail-Adresse √§ndern</h3>
                <form id="changeEmailForm">
                    <div class="form-group">
                        <label for="newEmail">Neue E-Mail-Adresse</label>
                        <input type="email" id="newEmail" required>
                    </div>

                    <div class="form-group">
                        <label for="emailPassword">Passwort best√§tigen</label>
                        <input type="password" id="emailPassword" required>
                        <div class="password-requirement">
                            Zur Best√§tigung wird Ihr Passwort ben√∂tigt
                        </div>
                    </div>

                    <div class="profile-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-envelope"></i> E-Mail √§ndern
                        </button>
                        <button type="reset" class="btn btn-secondary">
                            <i class="fas fa-undo"></i> Zur√ºcksetzen
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="profile-section">
            <div class="info-box">
                <i class="fas fa-info-circle"></i> 
                Verwalten Sie Ihre Kontoeinstellungen und Sicherheit.
            </div>

            <h3 style="font-size: 16px; margin-bottom: 20px; color: #333; margin-top: 30px;">
                <i class="fas fa-shield-alt"></i> Sicherheit
            </h3>

            <div id="settingsSuccess" class="alert alert-success" hidden>
                <i class="fas fa-check-circle"></i>
                <span></span>
            </div>
            <div id="settingsError" class="alert alert-danger" hidden>
                <i class="fas fa-exclamation-circle"></i>
                <span></span>
            </div>

            <div style="padding: 20px; background: #f9f9f9; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <h4 style="font-size: 14px; color: #333; margin-bottom: 5px; font-weight: 600;">
                            <i class="fas fa-key"></i> Sitzungen
                        </h4>
                        <p style="font-size: 12px; color: #666;">Verwalten Sie angemeldete Ger√§te</p>
                    </div>
                    <button type="button" id="logoutAllBtn" class="btn btn-danger">
                        <i class="fas fa-sign-out-alt"></i> √úberall abmelden
                    </button>
                </div>
            </div>

            <div style="padding: 20px; background: #fff3cd; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <h4 style="font-size: 14px; color: #856404; margin-bottom: 10px; font-weight: 600;">
                    <i class="fas fa-exclamation-triangle"></i> Konto l√∂schen
                </h4>
                <p style="font-size: 12px; color: #856404; margin-bottom: 15px;">
                    Dadurch werden alle Ihre Daten dauerhaft gel√∂scht. Dieser Vorgang kann nicht r√ºckg√§ngig gemacht werden.
                </p>
                <button type="button" id="deleteAccountBtn" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Konto l√∂schen
                </button>
            </div>
        </div>
        </div>
    </div>

    <div id="footer-container"></div>

    <script type="module">
        import { auth } from '../../js/firebase-config.js';
        import { VREUserAccountService } from '../../js/vre-user-account-service.js';
        import { 
            onAuthStateChanged, 
            reauthenticateWithCredential, 
            EmailAuthProvider, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword 
        } from 'https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js';

        let currentUser = null;
        let authStateSet = false;

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeProfile);
        } else {
            initializeProfile();
        }

        async function initializeProfile() {
            try {
                console.log('üîÑ Starting profile initialization...');
                const { VREUserAccountService } = await import('../../js/vre-user-account-service.js');
                const { 
                    onAuthStateChanged, 
                    reauthenticateWithCredential, 
                    EmailAuthProvider, 
                    signInWithEmailAndPassword, 
                    createUserWithEmailAndPassword 
                } = await import('https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js');

        let currentUser = null;
        let authStateSet = false;

        // Ensure elements are properly initialized
        document.addEventListener('DOMContentLoaded', () => {
            console.log('‚úÖ DOM Content Loaded');
            const authSection = document.getElementById('auth-section');
            const profileContent = document.getElementById('profile-content');
            const loader = document.getElementById('loading-indicator');
            
            console.log('Auth section:', authSection);
            console.log('Profile content:', profileContent);
            console.log('Loading indicator:', loader);
        });

        // Hide loading indicator and show content
        function hideLoading() {
            const loader = document.getElementById('loading-indicator');
            if (loader) {
                loader.style.display = 'none';
                console.log('‚úÖ Loading indicator hidden');
            }
        }

        // Show error message
        function showError(message) {
            hideLoading();
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 90%;
                z-index: 9999;
                text-align: center;
            `;
            errorDiv.innerHTML = `
                <div style="font-size: 48px; color: #ff6b6b; margin-bottom: 20px;">‚ö†Ô∏è</div>
                <h2 style="color: #333; margin-bottom: 15px; font-size: 20px;">Fehler beim Laden</h2>
                <p style="color: #666; margin-bottom: 20px; font-size: 14px; line-height: 1.5;">${message}</p>
                <button onclick="location.reload()" style="padding: 10px 30px; background: linear-gradient(135deg, #f97316, #fb923c); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
                    Seite neu laden
                </button>
            `;
            document.body.appendChild(errorDiv);
        }

        // Timeout fallback - show auth section if auth state doesn't fire within 5 seconds
        const authTimeoutId = setTimeout(() => {
            if (!authStateSet) {
                console.warn('‚ö†Ô∏è Auth state listener did not fire within 5 seconds - showing login form');
                hideLoading();
                const authSection = document.getElementById('auth-section');
                const profileContent = document.getElementById('profile-content');
                if (authSection) {
                    authSection.style.display = 'flex';
                    console.log('‚úÖ Auth section displayed (timeout fallback)');
                }
                if (profileContent) {
                    profileContent.style.display = 'none';
                }
                try {
                    setupAuthForms();
                } catch (e) {
                    console.error('Error in setupAuthForms:', e);
                    showError('Fehler beim Laden der Authentifizierung: ' + e.message);
                }
            }
        }, 5000);

        // Initialize page
        try {
            console.log('üîÑ Initializing profile page...');
            onAuthStateChanged(auth, async (user) => {
                console.log('Auth state changed:', user ? 'User logged in: ' + user.email : 'User not logged in');
                clearTimeout(authTimeoutId);
                authStateSet = true;
                hideLoading();
                
                try {
                    const authSection = document.getElementById('auth-section');
                    const profileContent = document.getElementById('profile-content');
                    
                    if (user) {
                        console.log('‚úÖ User is logged in:', user.email);
                        currentUser = user;
                        if (authSection) authSection.style.display = 'none';
                        if (profileContent) {
                            profileContent.style.display = 'block';
                            console.log('‚úÖ Profile content displayed');
                        }
                        await loadProfileData();
                    } else {
                        // Show auth forms if not authenticated
                        console.log('üîê User not logged in - showing login/register forms');
                        if (authSection) {
                            authSection.style.display = 'flex';
                            console.log('‚úÖ Auth section displayed');
                        }
                        if (profileContent) profileContent.style.display = 'none';
                        setupAuthForms();
                        console.log('‚úÖ Auth forms setup complete');
                    }
                } catch (error) {
                    console.error('Error in onAuthStateChanged callback:', error);
                    showError('Fehler beim Laden: ' + error.message);
                }
            });
        } catch (error) {
            console.error('Fatal error initializing profile page:', error);
            showError('Fehler beim Starten der Seite: ' + error.message);
        }
    } // End of initializeProfile function

        // Setup auth form handlers
        function setupAuthForms() {
            // Tab switching
            document.querySelectorAll('.profile-auth-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const formType = e.currentTarget.getAttribute('data-form');
                    document.querySelectorAll('.profile-auth-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.profile-auth-form').forEach(f => f.classList.remove('active'));
                    
                    e.currentTarget.classList.add('active');
                    document.getElementById(`profile${formType.charAt(0).toUpperCase() + formType.slice(1)}Form`).classList.add('active');
                });
            });

            // Password toggle
            document.querySelectorAll('.password-toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = btn.getAttribute('data-target');
                    const input = document.getElementById(targetId);
                    const icon = btn.querySelector('i');
                    
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    } else {
                        input.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            });

            // Login form
            document.getElementById('profileLoginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('profileLoginEmail').value;
                const password = document.getElementById('profileLoginPassword').value;
                const errorDiv = document.getElementById('loginError');
                
                try {
                    errorDiv.hidden = true;
                    const result = await signInWithEmailAndPassword(auth, email, password);
                    console.log('‚úÖ Anmeldung erfolgreich:', result.user.email);
                } catch (error) {
                    errorDiv.querySelector('span').textContent = error.message;
                    errorDiv.hidden = false;
                }
            });

            // Register form
            document.getElementById('profileRegisterForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('profileRegisterEmail').value;
                const password = document.getElementById('profileRegisterPassword').value;
                const errorDiv = document.getElementById('registerError');
                const successDiv = document.getElementById('registerSuccess');
                
                try {
                    errorDiv.hidden = true;
                    successDiv.hidden = true;
                    const result = await createUserWithEmailAndPassword(auth, email, password);
                    successDiv.querySelector('span').textContent = '‚úì Konto erfolgreich erstellt! Sie werden angemeldet...';
                    successDiv.hidden = false;
                    console.log('‚úÖ Registrierung erfolgreich:', result.user.email);
                } catch (error) {
                    errorDiv.querySelector('span').textContent = error.message;
                    errorDiv.hidden = false;
                }
            });
        }

        async function loadProfileData() {
            try {
                const userAccount = await VREUserAccountService.getUserAccount(currentUser.uid);
                
                if (!userAccount) {
                    console.warn('No user account found, creating default profile...');
                    // For first-time users without a profile yet
                    document.getElementById('profileName').textContent = currentUser.displayName || 'Benutzer';
                    document.getElementById('profileEmail').textContent = currentUser.email;
                    document.getElementById('fullName').value = currentUser.displayName || '';
                    document.getElementById('username').value = currentUser.email.split('@')[0] || '';
                    document.getElementById('email').value = currentUser.email || '';
                    document.getElementById('role').value = 'archaeologist';
                    return;
                }
                
                // Update header
                document.getElementById('profileName').textContent = userAccount.name || currentUser.displayName || 'Benutzer';
                document.getElementById('profileEmail').textContent = currentUser.email;

                // Update form fields
                document.getElementById('fullName').value = userAccount.name || '';
                document.getElementById('username').value = userAccount.username || '';
                document.getElementById('email').value = currentUser.email || '';
                document.getElementById('role').value = userAccount.role || 'archaeologist';

                // Load and display projects
                await loadUserProjects(userAccount);
                
                // Setup tab switching after profile is loaded
                setupTabSwitching();
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        async function loadUserProjects(userAccount) {
            try {
                const projectsContainer = document.getElementById('projects');
                
                // Get all projects (owned + participating)
                const ownedProjects = userAccount.ownProjects || [];
                const participatingProjects = userAccount.participatingProjects || [];
                const allProjects = [...new Set([...ownedProjects, ...participatingProjects])];
                
                if (allProjects.length === 0) {
                    projectsContainer.innerHTML = '<p class="text-muted" style="margin: 0; font-size: 12px;">Keine Projekte - <a href="/pages/sites/index.html">neues Projekt erstellen</a></p>';
                } else {
                    let projectsHTML = '<ul style="list-style: none; padding: 0; margin: 0;">';
                    allProjects.forEach(projectId => {
                        const isOwned = ownedProjects.includes(projectId);
                        const badge = isOwned ? ' <span style="font-size: 10px; color: #667eea; font-weight: 600;">(Eigent√ºmer)</span>' : '';
                        projectsHTML += `<li style="padding: 6px 0; font-size: 13px;">‚úì ${projectId}${badge}</li>`;
                    });
                    projectsHTML += '</ul>';
                    projectsContainer.innerHTML = projectsHTML;
                }
            } catch (error) {
                console.error('Error loading projects:', error);
            }
        }

        // Tab switching
        function setupTabSwitching() {
            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const sectionId = e.currentTarget.getAttribute('data-section');
                    
                    // Remove active from all tabs and sections
                    document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.profile-section').forEach(s => s.classList.remove('active'));
                    
                    // Add active to clicked tab and corresponding section
                    e.currentTarget.classList.add('active');
                    document.getElementById(sectionId).classList.add('active');
                });
            });
        }

        // Personal Information Form
        try {
            const usernameInput = document.getElementById('username');
            const fullNameInput = document.getElementById('fullName');
            
            // Real-time username validation
            if (usernameInput) {
                usernameInput.addEventListener('input', (e) => {
                    const username = e.target.value.trim();
                    const isValid = username.length >= 3 && /^[a-zA-Z0-9_.-]+$/.test(username);
                    
                    if (username.length > 0) {
                        e.target.style.borderColor = isValid ? '#22c55e' : '#ef4444';
                        e.target.style.backgroundColor = isValid ? '#f0fdf4' : '#fef2f2';
                    } else {
                        e.target.style.borderColor = '#e8eef7';
                        e.target.style.backgroundColor = '#f8faff';
                    }
                });
            }
            
            // Real-time name validation
            if (fullNameInput) {
                fullNameInput.addEventListener('input', (e) => {
                    const name = e.target.value.trim();
                    const isValid = name.length >= 2;
                    
                    if (name.length > 0) {
                        e.target.style.borderColor = isValid ? '#22c55e' : '#ef4444';
                        e.target.style.backgroundColor = isValid ? '#f0fdf4' : '#fef2f2';
                    } else {
                        e.target.style.borderColor = '#e8eef7';
                        e.target.style.backgroundColor = '#f8faff';
                    }
                });
            }
            
            document.getElementById('personalForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fullName = document.getElementById('fullName').value.trim();
            const username = document.getElementById('username').value.trim();
            const personalError = document.getElementById('personalError');
            const personalSuccess = document.getElementById('personalSuccess');
            const submitBtn = e.target.querySelector('button[type="submit"]');

            personalError.hidden = true;
            personalSuccess.hidden = true;

            // Validation
            if (!fullName || fullName.length < 2) {
                personalError.querySelector('span').textContent = '‚úó Vollst√§ndiger Name ist erforderlich (mindestens 2 Zeichen)';
                personalError.hidden = false;
                return;
            }

            if (!username || username.length < 3 || !/^[a-zA-Z0-9_.-]+$/.test(username)) {
                personalError.querySelector('span').textContent = '‚úó Benutzername muss mindestens 3 Zeichen lang sein und darf nur Buchstaben, Zahlen, Punkte, Bindestriche und Unterstriche enthalten';
                personalError.hidden = false;
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="loading-spinner"></span> Speichern...';

                await VREUserAccountService.updateUserProfile(currentUser.uid, {
                    name: fullName,
                    username: username
                });

                personalSuccess.querySelector('span').textContent = '‚úì Profil erfolgreich aktualisiert!';
                personalSuccess.hidden = false;

                setTimeout(() => {
                    loadProfileData();
                }, 1500);
            } catch (error) {
                personalError.querySelector('span').textContent = '‚úó Fehler: ' + error.message;
                personalError.hidden = false;
                console.error('Error updating profile:', error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Speichern';
            }
        });

        // Change Password Form
        try {
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            
            // Password strength indicator
            function getPasswordStrength(password) {
                let strength = 0;
                if (password.length >= 6) strength++;
                if (password.length >= 10) strength++;
                if (/[A-Z]/.test(password)) strength++;
                if (/[0-9]/.test(password)) strength++;
                if (/[^A-Za-z0-9]/.test(password)) strength++;
                return strength;
            }
            
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', (e) => {
                    const password = e.target.value;
                    const strength = getPasswordStrength(password);
                    const colors = ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e'];
                    
                    e.target.style.borderColor = colors[Math.min(strength, 4)];
                    e.target.style.backgroundColor = strength > 0 ? `${colors[Math.min(strength, 4)]}15` : '#f8faff';
                });
            }
            
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', (e) => {
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = e.target.value;
                    const match = newPassword === confirmPassword && newPassword.length > 0;
                    
                    e.target.style.borderColor = confirmPassword.length > 0 ? (match ? '#22c55e' : '#ef4444') : '#e8eef7';
                    e.target.style.backgroundColor = confirmPassword.length > 0 ? (match ? '#f0fdf4' : '#fef2f2') : '#f8faff';
                });
            }
            
            document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const passwordError = document.getElementById('passwordError');
            const passwordSuccess = document.getElementById('passwordSuccess');
            const submitBtn = e.target.querySelector('button[type="submit"]');

            passwordError.hidden = true;
            passwordSuccess.hidden = true;

            if (newPassword.length < 6) {
                passwordError.querySelector('span').textContent = '‚úó Passwort muss mindestens 6 Zeichen lang sein';
                passwordError.hidden = false;
                return;
            }

            if (newPassword !== confirmPassword) {
                passwordError.querySelector('span').textContent = '‚úó Passw√∂rter stimmen nicht √ºberein';
                passwordError.hidden = false;
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="loading-spinner"></span> Wird aktualisiert...';

                await VREUserAccountService.updateUserPassword(newPassword);

                passwordSuccess.querySelector('span').textContent = '‚úì Passwort erfolgreich ge√§ndert!';
                passwordSuccess.hidden = false;
                
                document.getElementById('changePasswordForm').reset();
                newPasswordInput.style.borderColor = '#e8eef7';
                confirmPasswordInput.style.borderColor = '#e8eef7';
                
                setTimeout(() => {
                    passwordSuccess.hidden = true;
                }, 3000);
            } catch (error) {
                passwordError.querySelector('span').textContent = '‚úó Fehler: ' + error.message;
                passwordError.hidden = false;
                console.error('Error changing password:', error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-lock"></i> Passwort √§ndern';
            }
        });
        } catch (error) {
            console.warn('Password form not ready yet:', error.message);
        }

        // Change Email Form
        try {
            const newEmailInput = document.getElementById('newEmail');
            
            if (newEmailInput) {
                newEmailInput.addEventListener('input', (e) => {
                    const email = e.target.value.trim();
                    const isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
                    
                    if (email.length > 0) {
                        e.target.style.borderColor = isValid ? '#22c55e' : '#ef4444';
                        e.target.style.backgroundColor = isValid ? '#f0fdf4' : '#fef2f2';
                    } else {
                        e.target.style.borderColor = '#e8eef7';
                        e.target.style.backgroundColor = '#f8faff';
                    }
                });
            }
            
            document.getElementById('changeEmailForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const newEmail = document.getElementById('newEmail').value.trim();
            const emailPassword = document.getElementById('emailPassword').value;
            const passwordError = document.getElementById('passwordError');
            const passwordSuccess = document.getElementById('passwordSuccess');
            const submitBtn = e.target.querySelector('button[type="submit"]');

            passwordError.hidden = true;
            passwordSuccess.hidden = true;

            // Email validation
            if (!newEmail || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newEmail)) {
                passwordError.querySelector('span').textContent = '‚úó Bitte geben Sie eine g√ºltige E-Mail-Adresse ein';
                passwordError.hidden = false;
                return;
            }

            if (!emailPassword) {
                passwordError.querySelector('span').textContent = '‚úó Passwort ist erforderlich zur Best√§tigung';
                passwordError.hidden = false;
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="loading-spinner"></span> Wird aktualisiert...';

                // Reauthenticate user
                const credential = EmailAuthProvider.credential(currentUser.email, emailPassword);
                await reauthenticateWithCredential(currentUser, credential);

                // Update email
                await VREUserAccountService.updateUserEmail(currentUser.uid, newEmail);

                passwordSuccess.querySelector('span').textContent = '‚úì E-Mail erfolgreich ge√§ndert! Sie werden weitergeleitet...';
                passwordSuccess.hidden = false;
                
                document.getElementById('changeEmailForm').reset();
                
                setTimeout(() => {
                    window.location.href = '/index.html';
                }, 2000);
            } catch (error) {
                const errorMsg = error.message.includes('auth/wrong-password') 
                    ? 'Falsches Passwort. Bitte versuchen Sie es erneut.' 
                    : error.message;
                passwordError.querySelector('span').textContent = '‚úó Fehler: ' + errorMsg;
                passwordError.hidden = false;
                console.error('Error changing email:', error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-envelope"></i> E-Mail √§ndern';
            }
        });
        } catch (error) {
            console.warn('Email form not ready yet:', error.message);
        }

        // Logout All Devices
        try {
            document.getElementById('logoutAllBtn').addEventListener('click', async () => {
                if (confirm('Sie werden von allen Ger√§ten abgemeldet. M√∂chten Sie fortfahren?')) {
                    try {
                        await auth.signOut();
                        window.location.href = '/index.html';
                    } catch (error) {
                        alert('Fehler: ' + error.message);
                    }
                }
            });
        } catch (error) {
            console.warn('Logout button not ready yet:', error.message);
        }

        // Delete Account
        try {
            document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
                const password = prompt('Geben Sie Ihr Passwort ein, um das Konto zu l√∂schen:');
                if (!password) return;

                if (!confirm('Dies l√∂scht Ihr Konto und alle damit verbundenen Daten dauerhaft. Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!')) {
                    return;
                }

                try {
                    // Reauthenticate user
                    const credential = EmailAuthProvider.credential(currentUser.email, password);
                    await reauthenticateWithCredential(currentUser, credential);

                    // Delete account
                    await VREUserAccountService.deleteUserAccount(currentUser.uid);

                    alert('‚úì Konto erfolgreich gel√∂scht!');
                    window.location.href = '/index.html';
                } catch (error) {
                    alert('‚úó Fehler: ' + error.message);
                    console.error('Error deleting account:', error);
                }
            });
        } catch (error) {
            console.warn('Delete button not ready yet:', error.message);
        }

        // Avatar Upload Handler
        try {
            const avatarUpload = document.getElementById('avatarUpload');
            const profileAvatarDisplay = document.getElementById('profileAvatarDisplay');

            if (avatarUpload) {
                avatarUpload.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('‚úó Bitte w√§hlen Sie eine Bilddatei');
                        return;
                    }

                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('‚úó Datei ist zu gro√ü (max. 5MB)');
                        return;
                    }

                    try {
                        // Create data URL for preview
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const dataUrl = event.target.result;
                            
                            // Update avatar display
                            profileAvatarDisplay.style.backgroundImage = `url('${dataUrl}')`;
                            profileAvatarDisplay.style.backgroundSize = 'cover';
                            profileAvatarDisplay.style.backgroundPosition = 'center';
                            profileAvatarDisplay.innerHTML = '';
                            
                            // Store in localStorage
                            localStorage.setItem('userAvatarUrl', dataUrl);
                            localStorage.setItem('userAvatarTimestamp', Date.now().toString());
                            
                            alert('‚úì Profilbild erfolgreich aktualisiert!');
                        };
                        reader.readAsDataURL(file);
                    } catch (error) {
                        alert('‚úó Fehler beim Upload: ' + error.message);
                        console.error('Error uploading avatar:', error);
                    }
                });
            }

            // Load saved avatar on page load
            function loadSavedAvatar() {
                if (profileAvatarDisplay) {
                    const savedAvatarUrl = localStorage.getItem('userAvatarUrl');
                    if (savedAvatarUrl) {
                        profileAvatarDisplay.style.backgroundImage = `url('${savedAvatarUrl}')`;
                        profileAvatarDisplay.style.backgroundSize = 'cover';
                        profileAvatarDisplay.style.backgroundPosition = 'center';
                        profileAvatarDisplay.innerHTML = '';
                    }
                }
            }

            // Call on page load
            loadSavedAvatar();

            // Header Logout Button
            const headerLogoutBtn = document.getElementById('headerLogoutBtn');
            if (headerLogoutBtn) {
                headerLogoutBtn.addEventListener('click', async () => {
                    try {
                        await auth.signOut();
                        window.location.href = '/index.html';
                    } catch (error) {
                        alert('Fehler beim Abmelden: ' + error.message);
                    }
                });
            }
        } catch (error) {
            console.warn('Avatar and logout handlers not ready yet:', error.message);
        }
    </script>

    <!-- Load header/footer after profile is initialized -->
    <script type="module" src="../../js/injectHeaderFooter.js"></script>
    <script type="module" src="../../js/auth-guard.js"></script>
    <script type="module" src="../../js/theme-toggle.js"></script>
</body>
</html>